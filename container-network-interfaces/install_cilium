#!/usr/bin/env bash
set -euo pipefail

reset=$(tput sgr0)
red=$(tput bold && tput setaf 1)
green=$(tput bold && tput setaf 2)
yellow=$(tput bold && tput setaf 3)
date_time=$(date +'%d-%m-%Y-T%H:%M:%S%z')
working_directory=$(pwd)
sudo_home=$(getent passwd "$SUDO_USER" | cut --delimiter=: --fields=6)

function error(){
  echo "[$date_time]: $*" >&2
}

# https://docs.cilium.io/en/v1.9/gettingstarted/k8s-install-kubeadm/
function cilium_init(){
  if [[ -e /usr/local/bin/helm ]]
  then
    echo "$yellow Initialising the control plane... $reset"
    kubeadm init
    source "$working_directory"/kubernetes/kubectl_configure
    echo "$yellow Installing Cilium & Enabling Hubble for Cluster-Wide Visibility... $reset"
    helm repo add cilium https://helm.cilium.io/
    helm repo update
    sleep 15s
    helm install cilium cilium/cilium --namespace=kube-system \
                                      --set hubble.listenAddress=":4244" \
                                      --set hubble.relay.enabled=true \
                                      --set hubble.ui.enabled=true
     echo "$green Cilium installation complete... $reset"
     cilium_connectivity_tests
  else
    error "$red Please ensure that helm is installed first as it is a dependency for installing Cilium... $reset"
    exit 1
  fi
}

function cilium_connectivity_tests(){
    echo "$yellow Create a namespace for Cilium Connectivity Tests... $reset"
    kubectl create namespace cilium-test
    echo "$yellow Deploying Cilium Connectivity Tests... $reset"
    kubectl apply --record --kubeconfig="$sudo_home"/.kube/config --namespace=cilium-test --filename=https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml
    echo "$green Cilium Connectivity Tests deployment complete... $reset"
}

cilium_init "$@"
